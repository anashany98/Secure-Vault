FROM node:18-alpine

WORKDIR /app

# Install dependencies first for better caching
COPY package*.json ./
RUN npm install --production

# Copy source code and scripts
COPY . .

# Set permissions for entrypoint
RUN chmod +x entrypoint.sh

EXPOSE 3000

# Environment defaults for production
ENV NODE_ENV=production
ENV RUN_MIGRATIONS=true

ENTRYPOINT ["./entrypoint.sh"]
CMD ["node", "index.js"]
